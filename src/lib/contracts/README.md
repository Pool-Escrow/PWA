# Contract Integration with wagmi-cli + viem

This directory contains auto-generated contract types and addresses using wagmi-cli as a dev tool, with viem for blockchain interactions.

## 🔄 **Automatic Updates**

Contract addresses are automatically extracted from Foundry deployment files and kept in sync via Turbo tasks:

```bash
# Generate/update contract types and addresses
bun run generate:contracts

# Or use Turbo (with caching)
turbo run generate:contracts

# Full deployment + sync workflow
bun run deploy:full
```

## 📁 **Files**

- `generated.ts` - Auto-generated by wagmi-cli (don't edit manually)
- `pool.ts` - Pool contract utilities and helpers
- `README.md` - This file

## 🚀 **Usage Examples**

### 1. **Contract Reading via API (Recommended)**

```typescript
import { readPoolInfoAPI, readUserRolesAPI } from '@/hooks/use-pool-contract'

// ✅ PREFERRED: Use API endpoints (reduces RPC calls)
async function loadPoolData(poolId: bigint) {
  try {
    const pool = await readPoolInfoAPI(poolId) // Via /api/pools/[id]
    return {
      name: pool.poolDetail.poolName,
      balance: pool.poolBalance.balance,
      status: pool.poolStatus,
    }
  } catch (error) {
    console.error('Failed to load pool:', error)
    return null
  }
}

// Check user roles via API
async function checkUserRoles(userAddress: Address) {
  try {
    const response = await readUserRolesAPI(userAddress) // Via /api/user-roles/[address]
    return response.roles // { isAdmin, isHost, isSponsor }
  } catch (error) {
    console.error('Failed to load roles:', error)
    return { isAdmin: false, isHost: false, isSponsor: false }
  }
}
```

### 2. **Contract Writing (Direct viem for transactions)**

```typescript
import { createPool } from '@/hooks/use-pool-contract'
import type { WalletClient } from 'viem'

// ✅ WRITE OPERATIONS: Use direct viem calls (transactions need wallet)
async function handleCreatePool(walletClient: WalletClient) {
  try {
    const hash = await createPool(walletClient, {
      endTime: BigInt(Math.floor(Date.now() / 1000) + 86400), // 24h from now
      startTime: BigInt(Math.floor(Date.now() / 1000) + 3600), // 1h from now
      poolName: "My Pool",
      tokenAddress: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // USDC
      feeRate: 500, // 5%
    }, 84532) // Base Sepolia
    
    console.log('Pool created:', hash)
  } catch (error) {
    console.error('Failed to create pool:', error)
  }
}
```

### 3. **Multi-Chain Support**

```typescript
import { getPoolAddress, isPoolDeployed } from '@/lib/contracts/pool'

function NetworkStatus() {
  const baseSepoliaAddress = getPoolAddress(84532)
  const baseMainnetAddress = getPoolAddress(8453)
  
  return (
    <div>
      <p>Base Sepolia: {isPoolDeployed(84532) ? baseSepoliaAddress : 'Not deployed'}</p>
      <p>Base Mainnet: {isPoolDeployed(8453) ? baseMainnetAddress : 'Not deployed'}</p>
    </div>
  )
}
```

### 4. **Event Watching (viem)**

```typescript
import { watchPoolEvents } from '@/hooks/use-pool-contract'

// Watch for pool events
const unwatch = watchPoolEvents(84532, (logs) => {
  console.log('New pool events:', logs)
})

// Stop watching
// unwatch()
```

## 🌐 **Available APIs**

### Backend Endpoints (Recommended for reads)

- **`GET /api/pools/[id]`** - Get complete pool information
- **`GET /api/user-roles/[address]`** - Get user admin/host/sponsor roles  
- **`GET /api/pools/[id]/participants/[address]`** - Get participant details
- **`GET /api/user-balances/[address]`** - Get user token balances

### Benefits of using APIs:
- ✅ **Reduced RPC calls** - Server handles blockchain interactions
- ✅ **Caching** - API responses are cached (5-30 minutes)
- ✅ **Error handling** - Consistent error responses
- ✅ **Rate limiting** - Server manages RPC rate limits
- ✅ **Performance** - Faster response times for users

## ⚙️ **Configuration**

The `wagmi.config.ts` file is automatically updated with real deployment addresses when you run:

```bash
bun run generate:contracts
```

**Turbo automatically handles:**
1. 📖 Reads Foundry broadcast files from `contracts/broadcast/`
2. 🔄 Extracts deployment addresses for each chain
3. ✏️ Updates `wagmi.config.ts` with real addresses
4. 🏗️ Generates TypeScript types in `generated.ts`
5. ⚡ **Caches results** - only runs when inputs change

## 🌐 **Supported Networks**

- **Base Sepolia** (84532) - Testnet
- **Base Mainnet** (8453) - Production (when deployed)
- **Local Anvil** (31337) - Development (when running locally)

## 🔁 **Development Workflow**

### **Contracts (Independent Submodule)**
1. **Deploy contracts**: `cd contracts && make deploy`
2. **Contracts are independent** - No frontend dependencies

### **Frontend (After Deployment)**
1. **Update types**: `bun run generate:contracts` or `turbo run generate:contracts`
2. **Use in components**: Import from `@/lib/contracts/pool`

### **Auto-sync in build**
- Contract generation runs automatically on `bun run build` or `bun run dev`
- Turbo caches results - only regenerates when contracts change
- **Frontend reads from `contracts/broadcast/` files** (no reverse dependency)

## 📝 **Type Safety**

All contracts are fully typed with TypeScript:

```typescript
import { poolAbi } from '@/lib/contracts/pool'
import type { Address } from 'viem'

// Function parameters are type-checked
const client = createPublicClient({ chain: baseSepolia, transport: http() })
const result = await client.readContract({
  abi: poolAbi,
  address: poolAddress as Address,
  functionName: 'pools', // ✅ Autocompleted and type-checked
  args: [poolId], // ✅ Type-checked arguments
})
```

## 🚨 **Important Notes**

- **Never edit `generated.ts` manually** - it's overwritten on each generation
- **Run `generate:contracts` after each deployment** to update addresses
- **Addresses are chain-specific** - use `getPoolAddress(chainId)` helper